name: Deploy Complete Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev/staging/prod)'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      destroy_first:
        description: 'Delete existing resources first'
        required: false
        default: false
        type: boolean
      deploy_sample_data:
        description: 'Deploy sample data and search index'
        required: false
        default: true
        type: boolean

# Permissions required for the workflow
permissions:
  contents: read
  actions: read
  id-token: write

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  # Configuration is now centralized in infrastructure-variables.yml
  # These values are loaded from the config file but can be overridden here if needed
  PRIMARY_LOCATION: 'centralus'
  AI_STUDIO_LOCATION: 'eastus2'
  PRIMARY_RG_NAME: 'techworkshop-l300-ai-agents-v2-${{ github.event.inputs.environment }}'
  AI_STUDIO_RG_NAME: 'azureai-v2-${{ github.event.inputs.environment }}-rg'
  CONFIG_FILE: 'src/infra/config/infrastructure-variables.yml'
  PARAMETERS_FILE: 'src/infra/parameters/${{ github.event.inputs.environment }}.parameters.json'

jobs:
  #============================================================================
  # PREPARATION PHASE
  #============================================================================
  prepare-deployment:
    runs-on: ubuntu-latest
    outputs:
      primary-rg: ${{ steps.setup.outputs.primary-rg }}
      ai-studio-rg: ${{ steps.setup.outputs.ai-studio-rg }}
      service-principal-id: ${{ steps.setup.outputs.service-principal-id }}
      should-destroy: ${{ steps.setup.outputs.should-destroy }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Setup deployment variables
      id: setup
      run: |
        echo "primary-rg=${{ env.PRIMARY_RG_NAME }}" >> $GITHUB_OUTPUT
        echo "ai-studio-rg=${{ env.AI_STUDIO_RG_NAME }}" >> $GITHUB_OUTPUT
        echo "service-principal-id=${{ secrets.AZURE_CLIENT_ID }}" >> $GITHUB_OUTPUT  
        echo "should-destroy=${{ github.event.inputs.destroy_first }}" >> $GITHUB_OUTPUT
        
    - name: Validate service principal permissions
      id: validate-permissions
      run: |
        echo "ðŸ” Validating service principal permissions..."
        
        # Get current service principal object ID
        SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        
        echo "Service Principal Object ID: $SP_OBJECT_ID"
        echo "Subscription ID: $SUBSCRIPTION_ID"
        
        # Check if service principal has Contributor role at subscription level
        CONTRIBUTOR_ROLE=$(az role assignment list \
          --assignee $SP_OBJECT_ID \
          --role "Contributor" \
          --scope "/subscriptions/$SUBSCRIPTION_ID" \
          --query "[0].roleDefinitionName" -o tsv)
          
        # Check if service principal has User Access Administrator role
        UAA_ROLE=$(az role assignment list \
          --assignee $SP_OBJECT_ID \
          --role "User Access Administrator" \
          --scope "/subscriptions/$SUBSCRIPTION_ID" \
          --query "[0].roleDefinitionName" -o tsv)
        
        # Validate required roles exist
        if [ "$CONTRIBUTOR_ROLE" != "Contributor" ]; then
          echo "âš ï¸ Missing Contributor role. Attempting to assign..."
          az role assignment create \
            --assignee $SP_OBJECT_ID \
            --role "Contributor" \
            --scope "/subscriptions/$SUBSCRIPTION_ID" \
            --output none
          echo "âœ… Contributor role assigned"
        else
          echo "âœ… Contributor role confirmed"
        fi
        
        if [ "$UAA_ROLE" != "User Access Administrator" ]; then
          echo "âš ï¸ Missing User Access Administrator role. Attempting to assign..."
          az role assignment create \
            --assignee $SP_OBJECT_ID \
            --role "User Access Administrator" \
            --scope "/subscriptions/$SUBSCRIPTION_ID" \
            --output none
          echo "âœ… User Access Administrator role assigned"
        else
          echo "âœ… User Access Administrator role confirmed"
        fi
        
        echo "âœ… All required permissions validated"
        
        echo "ðŸš€ Infrastructure Deployment Configuration"
        echo "=== CENTRALIZED CONFIGURATION ==="
        echo "Config File: ${{ env.CONFIG_FILE }}"
        echo "Parameters File: ${{ env.PARAMETERS_FILE }}"
        echo ""
        echo "=== ENVIRONMENT SETTINGS ==="
        echo "Environment: ${{ env.ENVIRONMENT }}"
        echo "Primary RG: ${{ env.PRIMARY_RG_NAME }}"
        echo "AI Studio RG: ${{ env.AI_STUDIO_RG_NAME }}"
        echo "Primary Location: ${{ env.PRIMARY_LOCATION }}"
        echo "AI Studio Location: ${{ env.AI_STUDIO_LOCATION }}"
        echo ""
        echo "=== DEPLOYMENT OPTIONS ==="
        echo "Destroy First: ${{ github.event.inputs.destroy_first }}"
        echo "Deploy Sample Data: ${{ github.event.inputs.deploy_sample_data }}"
        echo ""
        echo "=== CONFIGURATION FILES STATUS ==="
        if [ -f "${{ env.CONFIG_FILE }}" ]; then
          echo "âœ… Configuration file exists: ${{ env.CONFIG_FILE }}"
        else
          echo "âŒ Configuration file missing: ${{ env.CONFIG_FILE }}"
        fi
        if [ -f "${{ env.PARAMETERS_FILE }}" ]; then
          echo "âœ… Parameters file exists: ${{ env.PARAMETERS_FILE }}"
        else
          echo "âŒ Parameters file missing: ${{ env.PARAMETERS_FILE }}"
        fi

  #============================================================================
  # DESTRUCTION PHASE (if requested)
  #============================================================================
  destroy-infrastructure:
    runs-on: ubuntu-latest
    needs: prepare-deployment
    if: needs.prepare-deployment.outputs.should-destroy == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Delete AI Studio Resource Group
      run: |
        echo "ðŸ—‘ï¸ Deleting AI Studio Resource Group: ${{ needs.prepare-deployment.outputs.ai-studio-rg }}"
        if az group exists --name ${{ needs.prepare-deployment.outputs.ai-studio-rg }}; then
          az group delete --name ${{ needs.prepare-deployment.outputs.ai-studio-rg }} --yes --no-wait
          echo "âœ… AI Studio RG deletion initiated"
        else
          echo "â„¹ï¸ AI Studio RG does not exist"
        fi
        
    - name: Delete Primary Resource Group  
      run: |
        echo "ðŸ—‘ï¸ Deleting Primary Resource Group: ${{ needs.prepare-deployment.outputs.primary-rg }}"
        if az group exists --name ${{ needs.prepare-deployment.outputs.primary-rg }}; then
          az group delete --name ${{ needs.prepare-deployment.outputs.primary-rg }} --yes --no-wait
          echo "âœ… Primary RG deletion initiated"
        else
          echo "â„¹ï¸ Primary RG does not exist"
        fi
        
    - name: Wait for deletion completion
      run: |
        echo "â³ Waiting for resource groups to be fully deleted..."
        
        # Wait for AI Studio RG deletion
        while az group exists --name ${{ needs.prepare-deployment.outputs.ai-studio-rg }}; do
          echo "â³ Waiting for AI Studio RG deletion..."
          sleep 30
        done
        
        # Wait for Primary RG deletion  
        while az group exists --name ${{ needs.prepare-deployment.outputs.primary-rg }}; do
          echo "â³ Waiting for Primary RG deletion..."
          sleep 30
        done
        
        echo "âœ… All resource groups deleted successfully"

  #============================================================================
  # INFRASTRUCTURE DEPLOYMENT PHASE
  #============================================================================
  deploy-resource-groups:
    runs-on: ubuntu-latest
    needs: [prepare-deployment]
    if: always() && needs.prepare-deployment.result == 'success'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Create Primary Resource Group
      run: |
        echo "ðŸ—ï¸ Creating Primary Resource Group: ${{ needs.prepare-deployment.outputs.primary-rg }}"
        az group create \
          --name ${{ needs.prepare-deployment.outputs.primary-rg }} \
          --location ${{ env.PRIMARY_LOCATION }} \
          --tags \
            Environment=${{ env.ENVIRONMENT }} \
            Project="TechWorkshop-L300-AI-Agents" \
            ManagedBy="GitHubActions" \
            Repository="${{ github.repository }}"
        echo "âœ… Primary resource group created"
        
    - name: Create AI Studio Resource Group
      run: |
        echo "ðŸ—ï¸ Creating AI Studio Resource Group: ${{ needs.prepare-deployment.outputs.ai-studio-rg }}"
        az group create \
          --name ${{ needs.prepare-deployment.outputs.ai-studio-rg }} \
          --location ${{ env.AI_STUDIO_LOCATION }} \
          --tags \
            Environment=${{ env.ENVIRONMENT }} \
            Project="TechWorkshop-L300-AI-Agents" \
            ManagedBy="GitHubActions" \
            Repository="${{ github.repository }}" \
            Component="AIStudio"
        echo "âœ… AI Studio resource group created"

  deploy-main-infrastructure:
    runs-on: ubuntu-latest
    needs: [prepare-deployment]
    outputs:
      deployment-outputs: ${{ steps.deploy.outputs.deployment-outputs }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Get Service Principal Object ID
      id: get-sp-id
      run: |
        SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
        echo "service-principal-object-id=$SP_OBJECT_ID" >> $GITHUB_OUTPUT
        echo "Service Principal Object ID: $SP_OBJECT_ID"
        
    - name: Deploy Main Infrastructure
      id: deploy
      run: |
        echo "ðŸš€ Deploying main infrastructure..."
        
        # Deploy using centralized parameter file with runtime overrides
        DEPLOYMENT_OUTPUT=$(az deployment group create \
          --resource-group ${{ needs.prepare-deployment.outputs.primary-rg }} \
          --template-file src/infra/main-infrastructure.bicep \
          --parameters @${{ env.PARAMETERS_FILE }} \
          --parameters \
            servicePrincipalObjectId=${{ steps.get-sp-id.outputs.service-principal-object-id }} \
            repositoryName="${{ github.repository }}" \
          --query properties.outputs \
          --output json)
          
        # Properly encode JSON for GitHub Actions output
        echo "deployment-outputs<<EOF" >> $GITHUB_OUTPUT
        echo "$DEPLOYMENT_OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "âœ… Main infrastructure deployed successfully"
        
        # Display key outputs
        echo "ðŸ“‹ Deployment Outputs:"
        echo "$DEPLOYMENT_OUTPUT" | jq .

  deploy-ai-studio:
    runs-on: ubuntu-latest
    needs: [prepare-deployment, deploy-main-infrastructure]
    outputs:
      ai-studio-outputs: ${{ steps.deploy-ai.outputs.ai-studio-outputs }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Get Service Principal Object ID
      id: get-sp-id
      run: |
        SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
        echo "service-principal-object-id=$SP_OBJECT_ID" >> $GITHUB_OUTPUT
        
    - name: Deploy AI Studio Infrastructure
      id: deploy-ai
      run: |
        echo "ðŸš€ Deploying AI Studio infrastructure..."
        
        # Deploy AI Studio using centralized parameter file  
        AI_STUDIO_OUTPUT=$(az deployment group create \
          --resource-group ${{ needs.prepare-deployment.outputs.ai-studio-rg }} \
          --template-file src/infra/ai-studio.bicep \
          --parameters \
            location=${{ env.AI_STUDIO_LOCATION }} \
            environmentSuffix=${{ env.ENVIRONMENT }} \
            servicePrincipalObjectId=${{ steps.get-sp-id.outputs.service-principal-object-id }} \
            repositoryName="${{ github.repository }}" \
          --query properties.outputs \
          --output json)
          
        # Properly encode JSON for GitHub Actions output
        echo "ai-studio-outputs<<EOF" >> $GITHUB_OUTPUT
        echo "$AI_STUDIO_OUTPUT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "âœ… AI Studio infrastructure deployed successfully"
        
        # Display key outputs
        echo "ðŸ“‹ AI Studio Outputs:"
        echo "$AI_STUDIO_OUTPUT" | jq .

  #============================================================================
  # CONFIGURATION PHASE
  #============================================================================
  update-github-secrets:
    runs-on: ubuntu-latest
    needs: [prepare-deployment, deploy-main-infrastructure, deploy-ai-studio]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Extract deployment outputs
      id: extract
      run: |
        # Parse main infrastructure outputs
        MAIN_OUTPUTS='${{ needs.deploy-main-infrastructure.outputs.deployment-outputs }}'
        AI_OUTPUTS='${{ needs.deploy-ai-studio.outputs.ai-studio-outputs }}'
        
        # Extract key values (avoiding secrets in outputs)
        RESOURCE_GROUP=$(echo "$MAIN_OUTPUTS" | jq -r '.resourceGroupName.value')
        CONTAINER_REGISTRY=$(echo "$MAIN_OUTPUTS" | jq -r '.containerRegistryName.value')
        WEB_APP_NAME=$(echo "$MAIN_OUTPUTS" | jq -r '.webAppName.value')
        A2A_WEB_APP_NAME=$(echo "$MAIN_OUTPUTS" | jq -r '.a2aWebAppName.value')
        STORAGE_ACCOUNT=$(echo "$MAIN_OUTPUTS" | jq -r '.storageAccountName.value')
        
        AI_STUDIO_ENDPOINT=$(echo "$AI_OUTPUTS" | jq -r '.aiStudioProjectEndpoint.value')
        
        echo "resource-group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
        echo "container-registry=$CONTAINER_REGISTRY" >> $GITHUB_OUTPUT
        echo "web-app-name=$WEB_APP_NAME" >> $GITHUB_OUTPUT
        echo "a2a-web-app-name=$A2A_WEB_APP_NAME" >> $GITHUB_OUTPUT
        echo "storage-account=$STORAGE_ACCOUNT" >> $GITHUB_OUTPUT
        echo "ai-studio-endpoint=$AI_STUDIO_ENDPOINT" >> $GITHUB_OUTPUT
        
    - name: Update GitHub Secrets
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
      run: |
        echo "ðŸ” Updating GitHub Secrets with deployment outputs..."
        
        # Check if we have the necessary permissions
        if ! gh secret list >/dev/null 2>&1; then
          echo "âš ï¸  Warning: Unable to update GitHub secrets due to permissions."
          echo "ðŸ“‹ Please manually set the following secrets in your repository settings:"
          echo ""
          echo "AZURE_RESOURCE_GROUP=${{ steps.extract.outputs.resource-group }}"
          echo "AZURE_CONTAINER_REGISTRY=${{ steps.extract.outputs.container-registry }}"
          echo "AZURE_APP_SERVICE_NAME=${{ steps.extract.outputs.web-app-name }}"
          echo "AZURE_A2A_APP_SERVICE_NAME=${{ steps.extract.outputs.a2a-web-app-name }}"
          echo "STORAGE_ACCOUNT_NAME=${{ steps.extract.outputs.storage-account }}"
          echo "AZURE_AI_AGENT_ENDPOINT=${{ steps.extract.outputs.ai-studio-endpoint }}"
          echo "AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME=gpt-4o-mini"
          echo "AZURE_AI_AGENT_API_VERSION=2024-12-01-preview"
          echo ""
          echo "â„¹ï¸  Go to: Settings > Secrets and variables > Actions > New repository secret"
          echo "ðŸ”— https://github.com/${{ github.repository }}/settings/secrets/actions"
          exit 0
        fi
        
        # Core resource information (only set if values are not empty)
        if [ -n "${{ steps.extract.outputs.resource-group }}" ]; then
          gh secret set AZURE_RESOURCE_GROUP --body "${{ steps.extract.outputs.resource-group }}"
        fi
        if [ -n "${{ steps.extract.outputs.container-registry }}" ]; then
          gh secret set AZURE_CONTAINER_REGISTRY --body "${{ steps.extract.outputs.container-registry }}"
        fi
        if [ -n "${{ steps.extract.outputs.web-app-name }}" ]; then
          gh secret set AZURE_APP_SERVICE_NAME --body "${{ steps.extract.outputs.web-app-name }}"
        fi
        if [ -n "${{ steps.extract.outputs.a2a-web-app-name }}" ]; then
          gh secret set AZURE_A2A_APP_SERVICE_NAME --body "${{ steps.extract.outputs.a2a-web-app-name }}"
        fi
        if [ -n "${{ steps.extract.outputs.storage-account }}" ]; then
          gh secret set STORAGE_ACCOUNT_NAME --body "${{ steps.extract.outputs.storage-account }}"
        fi
        
        # AI Studio configuration
        if [ -n "${{ steps.extract.outputs.ai-studio-endpoint }}" ]; then
          gh secret set AZURE_AI_AGENT_ENDPOINT --body "${{ steps.extract.outputs.ai-studio-endpoint }}"
          gh secret set AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME --body "gpt-4o-mini"
          gh secret set AZURE_AI_AGENT_API_VERSION --body "2024-12-01-preview"
        fi
        
        echo "âœ… GitHub secrets updated successfully"

  get-service-keys:
    runs-on: ubuntu-latest  
    # Temporarily disabled dependencies for testing - uncomment when ready
    # needs: [prepare-deployment, deploy-main-infrastructure, deploy-ai-studio, update-github-secrets]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Get service keys and update secrets
      run: |
        echo "ðŸ”‘ Retrieving service keys..."
        
        # TESTING MODE: Using hardcoded values from previous successful deployment
        # Replace these with dynamic values when re-enabling full workflow
        
        # Get resource names from previous deployment
        RESOURCE_GROUP="techworkshop-l300-ai-agents-centralus"
        AI_RESOURCE_GROUP="techworkshop-l300-ai-agents-centralus"
        
        STORAGE_ACCOUNT="stowrgnenm7wj2y"
        COSMOS_ACCOUNT="owrgnenm7wj2y-cosmosdb"
        SEARCH_SERVICE="owrgnenm7wj2y-search"
        AI_SERVICES="owrgnenm7wj2y-ai-services"
        APP_INSIGHTS="owrgnenm7wj2y-app-insights"
        
        # Debug: Show parsed values
        echo "Debug - Parsed values:"
        echo "RESOURCE_GROUP: '$RESOURCE_GROUP'"
        echo "STORAGE_ACCOUNT: '$STORAGE_ACCOUNT'"
        echo "COSMOS_ACCOUNT: '$COSMOS_ACCOUNT'"
        echo "SEARCH_SERVICE: '$SEARCH_SERVICE'"
        
        AI_STUDIO_HUB="admin-mh2k31bc-eastus2"
        
        # Validate required values exist
        if [ -z "$STORAGE_ACCOUNT" ] || [ "$STORAGE_ACCOUNT" = "null" ]; then
          echo "âŒ ERROR: Storage account name not found in deployment outputs"
          exit 1
        fi
        
        if [ -z "$RESOURCE_GROUP" ] || [ "$RESOURCE_GROUP" = "null" ]; then
          echo "âŒ ERROR: Resource group name not found in deployment outputs"
          exit 1
        fi
        
        # SIMPLE TEST: Just check Azure CLI access and resource existence
        echo "Testing Azure CLI access..."
        az account show --output table
        
        echo "Testing resource group access..."
        az group show --name "$RESOURCE_GROUP" --output table
        
        echo "Testing storage account existence..."
        az storage account show --name "$STORAGE_ACCOUNT" --resource-group "$RESOURCE_GROUP" --output table
        
        echo "âœ… Basic Azure CLI operations successful"
        
        # TESTING COMPLETE - Exit here to avoid complex operations
        echo "ðŸŽ¯ Test successful - Azure CLI authentication and basic resource access working"
        exit 0
        
        echo "Getting Cosmos DB key for account: $COSMOS_ACCOUNT"
        COSMOS_KEY=$(az cosmosdb keys list --name "$COSMOS_ACCOUNT" --resource-group "$RESOURCE_GROUP" --query primaryMasterKey -o tsv)
        echo "âœ… Cosmos DB key retrieved successfully"
        # gh secret set COSMOS_KEY --body "$COSMOS_KEY"
        COSMOS_ENDPOINT=$(az cosmosdb show --name "$COSMOS_ACCOUNT" --resource-group "$RESOURCE_GROUP" --query documentEndpoint -o tsv)
        echo "âœ… Cosmos DB endpoint retrieved: $COSMOS_ENDPOINT"
        # gh secret set COSMOS_ENDPOINT --body "$COSMOS_ENDPOINT"
        
        # Validate AI Search service name
        if [ -z "$SEARCH_SERVICE" ] || [ "$SEARCH_SERVICE" = "null" ]; then
          echo "âŒ ERROR: AI Search service name not found in deployment outputs"
          exit 1
        fi
        
        echo "Getting AI Search key for service: $SEARCH_SERVICE"
        SEARCH_KEY=$(az search admin-key show --service-name "$SEARCH_SERVICE" --resource-group "$RESOURCE_GROUP" --query primaryKey -o tsv)
        echo "âœ… AI Search key retrieved successfully"
        # gh secret set SEARCH_KEY --body "$SEARCH_KEY"
        SEARCH_ENDPOINT="https://${SEARCH_SERVICE}.search.windows.net"
        echo "âœ… AI Search endpoint: $SEARCH_ENDPOINT"
        # gh secret set SEARCH_ENDPOINT --body "$SEARCH_ENDPOINT"
        
        echo "Getting OpenAI key..."
        OPENAI_KEY=$(az cognitiveservices account keys list --name $AI_SERVICES --resource-group $RESOURCE_GROUP --query key1 -o tsv)
        echo "âœ… OpenAI key retrieved successfully"
        # gh secret set AZURE_OPENAI_KEY --body "$OPENAI_KEY"
        OPENAI_ENDPOINT=$(az cognitiveservices account show --name $AI_SERVICES --resource-group $RESOURCE_GROUP --query properties.endpoint -o tsv)
        echo "âœ… OpenAI endpoint: $OPENAI_ENDPOINT"
        # gh secret set AZURE_OPENAI_ENDPOINT --body "$OPENAI_ENDPOINT"
        
        echo "Getting AI Studio keys..."
        AI_STUDIO_KEY=$(az cognitiveservices account keys list --name $AI_STUDIO_HUB --resource-group $AI_RESOURCE_GROUP --query key1 -o tsv)
        echo "âœ… AI Studio key retrieved successfully"
        # gh secret set GPT_API_KEY --body "$AI_STUDIO_KEY"
        AI_STUDIO_ENDPOINT=$(az cognitiveservices account show --name $AI_STUDIO_HUB --resource-group $AI_RESOURCE_GROUP --query properties.endpoint -o tsv)
        echo "âœ… AI Studio endpoint: $AI_STUDIO_ENDPOINT"
        # gh secret set GPT_ENDPOINT --body "$AI_STUDIO_ENDPOINT"
        
        echo "Getting Application Insights connection..."
        APP_INSIGHTS_CONN=$(az monitor app-insights component show --app $APP_INSIGHTS --resource-group $RESOURCE_GROUP --query connectionString -o tsv)
        echo "âœ… App Insights connection retrieved successfully"
        # gh secret set APPLICATIONINSIGHTS_CONNECTION_STRING --body "$APP_INSIGHTS_CONN"
        
        # Set database/container names
        
        # gh secret set DATABASE_NAME --body "zava"
        # gh secret set CONTAINER_NAME --body "product_catalog"
        
        echo "âœ… All service keys retrieved successfully (TEST MODE - secrets not set)"

  #============================================================================
  # DATA DEPLOYMENT PHASE - DISABLED FOR TESTING
  #============================================================================
  deploy-sample-data:
    runs-on: ubuntu-latest
    needs: [get-service-keys]  # Simplified dependency for testing
    if: github.event.inputs.deploy_sample_data == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Install Python dependencies
      run: |
        cd src
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create environment file
      run: |
        cd src
        cat > .env << 'EOF'
        # Get values from GitHub secrets
        COSMOS_ENDPOINT="${{ secrets.COSMOS_ENDPOINT }}"
        COSMOS_KEY="${{ secrets.COSMOS_KEY }}"
        DATABASE_NAME="${{ secrets.DATABASE_NAME }}"
        CONTAINER_NAME="${{ secrets.CONTAINER_NAME }}"
        
        SEARCH_ENDPOINT="${{ secrets.SEARCH_ENDPOINT }}"
        SEARCH_KEY="${{ secrets.SEARCH_KEY }}"
        INDEX_NAME="zava-product-catalog"
        
        AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}"
        AZURE_OPENAI_KEY="${{ secrets.AZURE_OPENAI_KEY }}"
        AZURE_OPENAI_API_VERSION="2024-12-01-preview"
        EOF
        
    - name: Deploy data to Cosmos DB
      run: |
        cd src
        echo "ðŸ“¦ Ingesting product data to Cosmos DB..."
        python pipelines/ingest_to_cosmos.py
        echo "âœ… Product data ingested successfully"
        
    - name: Create AI Search index
      run: |
        cd src
        echo "ðŸ” Creating AI Search index..."
        python pipelines/create_search_index.py
        echo "âœ… AI Search index created successfully"

  #============================================================================
  # VALIDATION PHASE
  #============================================================================
  validate-deployment:
    runs-on: ubuntu-latest
    needs: [get-service-keys]  # Simplified for testing
    if: always() && !failure()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Azure CLI
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Validate infrastructure deployment
      run: |
        echo "âœ… Test Infrastructure Deployment Validation"
        echo "============================================="
        echo ""
        echo "ðŸŽ¯ Testing Phase Complete"
        echo "- Azure CLI authentication: âœ… Working"
        echo "- Resource access: âœ… Working" 
        echo "- Basic service operations: âœ… Working"
        
        echo ""
        echo "ðŸŽ¯ Next Steps:"
        echo "1. Deploy AI agents using existing workflows"
        echo "2. Build and deploy container applications"
        echo "3. Test end-to-end functionality"
        
        echo "âœ… Infrastructure deployment completed successfully!"